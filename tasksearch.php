<?php
	include('pattern/connexion_mysql.php');
	if (isset($_POST['daterapport']))
	{
		$result2 = $bdd->prepare("SELECT * FROM work INNER JOIN scheduled_tasks ON Task_ID = Work_TaskID INNER JOIN equipe ON Task_EquipeID = Equipe_ID WHERE Work_DayToRealise BETWEEN '".$_POST['daterapport']."' AND '".$_POST['daterapport2']."'");
		$result2->execute();
		$excel = "Rapport des taches d'exploitations du ".$_POST['daterapport']." au ".$_POST['daterapport2']."/n/n/n";
		$excel .= "Tache /t Action /t Equipe /t Heure de realisation /t Heure realisee /t Commentaire /t Date /n/n";
		while($donnees2=$result2->fetch()) 
		{
			$excel .= $donnees2['Task_Name']." /t ".$donnees2['Task_Action']." /t ".$donnees2['Equipe_Name']." /t ".$donnees2['Task_Hour']." /t ".$donnees2['Work_HourDone']." /t ".$donnees2['Work_Commentary']." /t ".$donnees2['Work_DayToRealise']." /n";
		}
		header("Content-type: application/vnd.ms-excel;charset=ANSI");
		header("Content-disposition: attachment; filename=Rapport_Exploitation.xls");
		print $excel;
		exit;
	}
	$date1 = date("Y-m-d");
	$date2 = date("Y-m-d");
	if (isset($_POST['date1']))
	{
		$date1 = $_POST['date1'];
		$date2 = $_POST['date2'];
	}
	session_start();
	$date = date("Y-m-d");	
	$result = $bdd->prepare("SELECT * FROM work INNER JOIN scheduled_tasks ON Task_ID = Work_TaskID WHERE Task_EquipeID = ".$_SESSION["equipeID"]." AND Task_Realised != 1 AND Work_DayToRealise = '".$date."' ORDER BY Work_DayToRealise, Work_Hour");
	$result->execute();		
?>

<!DOCTYPE html>
<head>
<title> Gestion Exploitation - Recherche de tâches </title>
</head>
<link rel="stylesheet" type="text/css" href="css/menu_search.css"/>
<body>
	<?php
		echo "<button type=\"button\" style=\"font-size: 20px; border-radius:5px;\" onclick=\"self.location.href='work.php'\">
		Retour
		</button>";
	?>
	<div id="search">
		<br/><br/>
		<form method="POST" action="tasksearch.php">
			<label> Rechercher les tâches entre le </label> 
			<input type="datetime" name="date1" size="30" required="required" value="<?php echo $date1;?>"/>
			<label> et le </label>
			<input type="datetime" name="date2" size="30" required="required" value="<?php echo $date2;?>"/><br/><br/>
			<input type="submit" style="font-size: 20px; border-radius:5px;" value="Rechercher"/>
		</form>

		<div id="div_search">
				<h3> Recherche de tâches </h3>
				<?php		
					$result = $bdd->prepare("SELECT * FROM work INNER JOIN scheduled_tasks ON Task_ID = Work_TaskID WHERE Work_DayToRealise BETWEEN '".$date1."' AND '".$date2."' ORDER BY Work_DayToRealise,Task_Hour");
					$result->execute();
					echo "<table border=\"2\"><TR>";
					echo "<TH> Nom </TH>";
					echo "<TH> Action </TH>";
					echo "<TH> Procédure </TH>";
					echo "<TH> Fichier </TH>";
					echo "<TH> Date </TH>";
					echo "<TH> Heure </TH>";
					echo "<TH> Etat </TH>";
					echo "<TH> OK/KO </TH>";
					echo "<TH> Heure terminé </TH>";
					echo "<TH> Utilisateur </TH>";
					echo "<TH> Commentaire </TH>";
					echo "<TH> Valider la tâche </TH>";
					echo "</TR>";
					while ($donnees=$result->fetch())
					{
						echo "<TR>";
						echo "<TD>".$donnees['Task_Name']."</TD>";			
						echo "<TD>".$donnees['Task_Action']."</TD>";
					if ($donnees['Task_Process'] == "" or $donnees['Task_Process'] == NULL)
					{
						?>
						<TD></TD>
						<?php
					}
					else if (preg_match("#^http#",$donnees['Task_Process']) == true)
					{
						?>
						<TD><a href="<?php echo $donnees['Task_Process'];?>" target="_blank"> Procédure </a></TD>
						<?php
					}
					else
					{
						?>						
						<TD><a href="file://<?php echo $donnees['Task_Process'];?>" target="_blank"> Procédure </a></TD>
						<?php						
					}
					if ($donnees['Task_File'] == "" or $donnees['Task_File'] == NULL)
					{
						?>
						<TD></TD>
						<?php
					}
					else if (preg_match("#^http#",$donnees['Task_File']) == true)
					{
						?>
						<TD><a href="<?php echo $donnees['Task_File'];?>" target="_blank"> Fichier </a></TD>
						<?php
					}
					else
					{
						?>						
						<TD><a href="file://<?php echo $donnees['Task_File'];?>" target="_blank"> Fichier </a></TD>
						<?php						
					}
						echo "<TD>".$donnees['Work_DayToRealise']."</TD>";
						echo "<TD>".$donnees['Task_Hour']."</TD>";
						if ($donnees['Work_Realised'] == 1)
						{
							echo "<TD> Effectuée </TD>";	
						}
						else
						{
							echo "<TD> Non effectuée </TD>";
						}
						if ($donnees['Work_OK'] == 1)
						{
							echo "<TD>OK</TD>";
						}
						else if($donnees['Work_OK'] == 0)
						{
							echo "<TD>KO</TD>";
						}
						echo "<TD>".$donnees['Work_HourDone']."</TD>";								
						echo "<TD>".$donnees['Work_UserName']."</TD>";
						echo "<TD>".$donnees['Work_Commentary']."</TD>";								
						if ($donnees['Work_Realised'] == 0)
						{
							echo "<TD><button type=\"button\" style=\"font-size: 16px; border-radius:5px;\" onclick=\"self.location.href='finish_task.php?taskFinishing=1&id_task=".$donnees['Work_ID']."'\"/>Valider </button></TD>";
						}
						else 
						{
							echo "<TD><button type=\"button\" style=\"font-size: 16px; border-radius:5px;\" onclick=\"self.location.href='finish_task.php?taskFinishing=1&id_task=".$donnees['Work_ID']."'\"/>Modifier</button></TD>";
						}
						echo "</TR>";			
					}
					echo "</table>";
					$result->closeCursor();
				?>
				<br/><br/><br/>
				<h3> Rapport de tâches d'exploitation </h3>
				<form method="POST" action="tasksearch.php">
				<label> Date du rapport à générer entre le </label><br/>
				<input type="date" name="daterapport"/>
				<label> et le </label>
				<input type="date" name="daterapport2"/>
				<input type="submit" style="font-size: 20px; border-radius:5px;" value="Générer rapport"/>
				</form>
				
		</div>
	</div>
</body>
</html>
