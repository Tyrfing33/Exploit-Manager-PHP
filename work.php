<?php	
	session_start();	
	if (!isset($_SESSION['login'])) 
	{
		header("Location: destination.php");
		exit;
	}
?>

<?php
	function switchdate($var) 
	{ 
	$tab = explode("-",$var); 
	$datechangee = $tab[2]."-".$tab[1]."-".$tab[0]; 
	return $datechangee ; 
	} 
	$date = date("Y-m-d");
	include('pattern/connexion_mysql.php');
	$result = $bdd->prepare("SELECT * FROM work INNER JOIN scheduled_tasks ON Task_ID = Work_TaskID WHERE Task_EquipeID = ".$_SESSION["equipeID"]." AND Work_DayToRealise = '".$date."' ORDER BY Task_Hour");
	$result->execute();		
?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Gestion Exploitation - Espace de travail</title>
</head>
<link rel="stylesheet" type="text/css" href="css/menu_work.css"/>
<body>
	<div id="div_session">	
		
		<form method="POST" action="connexion.php">
		<?php echo "<p> Bonjour, <font color=\"blue\">".$_SESSION["nom"]." ".$_SESSION["prenom"]."</font><p/>";?>
		<input style="font-size: 20px; border-radius:5px;" type="submit" name="logout" value="Se déconnecter"/>
		</form>
		<?php
			#if ($_SESSION['teamleader'] == true)
			#{
				echo '<a href="backoffice.php">Gestion de l\'application</a>';
			#}
		?>
	</div>
	<h1> Gestion Exploitation - Espace de travail de l'équipe <?php echo "<font color=\"red\">".$_SESSION["equipe"]."</font>";?></h1>
	<div id="table">
		<div id="div_work">
			<h3> Travail à faire le <?php echo date("d-m-Y");?> </h3>
			<?php		
				
				echo "<table border=\"2\"><TR>";
				echo "<TH> Nom </TH>";
				echo "<TH> Action </TH>";
				echo "<TH> Procédure </TH>";
				echo "<TH> Fichier </TH>";
				echo "<TH> Date </TH>";
				echo "<TH> Heure </TH>";
				echo "<TH> Etat </TH>";			
				echo "<TH> Utilisateur </TH>";			
				echo "<TH> Valider la tâche </TH>";
				echo "</TR>";
				while ($donnees=$result->fetch())
				{
					echo "<TR>";
					echo "<TD>".$donnees['Task_Name']."</TD>";			
					echo "<TD>".$donnees['Task_Action']."</TD>";
					if ($donnees['Task_Process'] != "")
					{
						?>
						<TD><a href="<?php fopen($donnees['Task_Process'],'w')?>"> Procédure </a></TD>
						<?php
					}
					else
					{
						?>
						<TD><a href="<?php echo $donnees['Task_Process'];?>"> Procédure </a></TD>
						<?php
					}
					echo "<TD><a href=\"".fopen($donnees['Task_File'], 'w')."\"> Fichier </a></TD>";
					echo "<TD>".date("d-m-Y")."</TD>";
					echo "<TD>".$donnees['Task_Hour']."</TD>";
					if ($donnees['Work_Realised'] == 1)
					{
						echo "<TD> Effectuée </TD>";	
					}
					else
					{
						echo "<TD> Non effectuée </TD>";
					}				
					echo "<TD>".$donnees['Work_UserName']."</TD>";								
					if ($donnees['Work_Realised'] == 0)
					{
						echo "<TD><button type=\"button\" style=\"font-size: 20px; border-radius:5px;\" onclick=\"self.location.href='finish_task.php?taskFinishing=1&id_task=".$donnees['Work_ID']."'\"/>Valider </button></TD>";
					}
					else 
					{
						echo "<TD><button type=\"button\" style=\"font-size: 20px; border-radius:5px;\" onclick=\"self.location.href='finish_task.php?taskFinishing=1&id_task=".$donnees['Work_ID']."'\"/>Modifier</button></TD>";
					}
					echo "</TR>";			
				}
				echo "</table>";
			$result->closeCursor();		
		?>
		</div>
		
		<div id="div_ancientwork">
			<?php
				$result3 = $bdd->prepare("SELECT * FROM work INNER JOIN scheduled_tasks ON Task_ID = Work_TaskID WHERE Work_Realised IS NULL AND Task_EquipeID = ".$_SESSION["equipeID"]." AND Work_DayToRealise < '".$date."' ORDER BY Work_DayToRealise, Task_Hour");
				$result3->execute();
				$compte = $result3->rowCount();
				if ($compte > 1)
				{
					echo "<h3><font size=\"15px\" face=\"Arial\" color=\"red\">".$compte."</font> anciennes tâches non terminées </h3>";
				}
				else if($compte == 1)
				{
					echo "<h3><font size=\"15px\" face=\"Arial\" color=\"red\">".$compte."</font> ancienne tâche non terminée </h3>";
				}
			?>
			<?php
				if ($compte > 0)
				{
					$result2 = $bdd->prepare("SELECT * FROM work INNER JOIN scheduled_tasks ON Task_ID = Work_TaskID WHERE Work_Realised IS NULL AND Task_EquipeID = ".$_SESSION["equipeID"]." AND Work_DayToRealise < '".$date."' ORDER BY Work_DayToRealise, Task_Hour");
					$result2->execute();
					echo "<table border=\"'2\"'><TR>";
					echo "<TH> Nom </TH>";
					echo "<TH> Action </TH>";
					echo "<TH> Procédure </TH>";
					echo "<TH> Fichier </TH>";
					echo "<TH> Date </TH>";
					echo "<TH> Heure </TH>";
					echo "<TH> Etat </TH>";			
					echo "<TH> Utilisateur </TH>";			
					echo "<TH> Valider la tâche </TH>";
					echo "</TR>";
					while ($donnees2=$result2->fetch())
					{					
						echo "<TR>";
						echo "<TD>".$donnees2['Task_Name']."</TD>";			
						echo "<TD>".$donnees2['Task_Action']."</TD>";
						if ($donnees['Task_Process'] != "")
						{
							?>
							<TD><a href="<?php fopen($donnees['Task_Process'],'w')?>"> Procédure </a></TD>
							<?php
						}
						else
						{
							?>
							<TD><a href="<?php echo $donnees2['Task_Process'];?>"> Procédure </a></TD>
							<?php
						}
						echo "<TD><a href=\"".fopen($donnees2['Task_File'], 'w')."\"> Fichier </a></TD>";
						$datework = new DateTime($donnees2['Work_DayToRealise']);
						echo "<TD>".$datework->format('d-m-Y')."</TD>";
						echo "<TD>".$donnees2['Task_Hour']."</TD>";
						if ($donnees2['Work_Realised'] == 1)
						{
							echo "<TD> Effectuée </TD>";	
						}
						else
						{
							echo "<TD> Non effectuée </TD>";
						}				
						echo "<TD>".$donnees2['Work_UserName']."</TD>";
						if ($donnees['Work_Realised'] == 0)
						{
							echo "<TD><button type=\"button\" style=\"font-size: 20px; border-radius:5px;\" onclick=\"self.location.href='finish_task.php?taskFinishing=1&id_task=".$donnees2['Work_ID']."'\"/>Valider </button></TD>";
						}
						else 
						{
							echo "<TD><button type=\"button\" style=\"font-size: 20px; border-radius:5px;\" onclick=\"self.location.href='finish_task.php?taskFinishing=1&id_task=".$donnees2['Work_ID']."'\"/>Modifier</button></TD>";
						}
						echo "</TR>";			
					}
					echo "</table>";
					$result2->closeCursor();
					$result3->closeCursor();
				}
			?>
		</div>
	</div>
		
	<a href="tasksearch.php">Recherche de tâches</a>
	
</body>
</html>
