<?php	
	session_start();	
	if (!isset($_SESSION['login'])) 
	{
		header("Location: connexion.php");
	}
?>

<?php
	include('class/user.php');
	include('pattern/connexion_mysql.php');
	session_start();
	#Recuperation des utilisateurs pour affichage dans le tableau HTML
	$onglet = $bdd->query("SELECT * FROM equipe");
	$onglet->execute();
	$result = $bdd->query("SELECT * FROM user WHERE User_EquipeID=".$_SESSION['equipeID']."");
	$result->execute();
		
?>

<!DOCTYPE html>
<head>
<title> Gestion Exploitation - Gestion des utilisateurs </title>
<meta charset="UTF-8">
</head>
<link rel="stylesheet" type="text/css" href="css/menu_user.css"/>
<body>
	<input type="button" value="Retour" onClick="document.location.href = 'backoffice.php'"/>
	<h1>Gestion des utilisateurs</h1>
	<?php
		#Initialisation du tableau avec bouton d'ajout d'utilisateur et un bouton d'édition sur chaque utilisateur.
				
		if ($_SESSION['droit'] == 1)
		{
			echo"<div id=\"tabs\" class=\"tabbed_box\">";			
			echo "<div class=\"tabbed_area\">";
			echo "<TD><button type=\"button\" onclick=\"self.location.href='add_user.php'\">
			Ajouter utilisateur
			</button></TD></br>";
				echo "<ul class=\"tabs\">";
					$numero = 1;
					while ($onglets=$onglet->fetch())
					{					
						echo "<li> <a href=\"gestion_user.php?idonglet=".$onglets['Equipe_ID']."\" id=\"tab_".$numero."\"class=\"\">".$onglets['Equipe_Name']."</a></li>";
						$numero = $numero + 1;						
					}
				echo "</ul></br>";				
				if (isset($_GET['idonglet']))
				{
					$idonglet = $_GET['idonglet'];
					echo "<div id=\"content\" class=\"content\">";
					echo "<table border=\"'2\"'><TR>";
					echo "<TH> Nom </TH>";
					echo "<TH> Prénom </TH>";
					echo "<TH> Equipe </TH>";
					echo "<TH> Login </TH>";
					echo "</TR>";
					$result2 = $bdd->query("SELECT * FROM user WHERE User_EquipeID=".$idonglet."");
					$result2->execute();
					while ($donnees2=$result2->fetch())
					{						
						echo "<TR>";
						echo "<TD>".$donnees2['User_Name']."</TD>";			
						echo "<TD>".$donnees2['User_FirstName']."</TD>";			
						echo "<TD>".$donnees2['User_EquipeID']."</TD>";			
						echo "<TD>".$donnees2['User_Login']."</TD>";
						echo "<TD> <button type=\"button\" onclick=\"self.location.href='edit_user.php?user_login=".$donnees2['User_Login']."'\" style=\"background-color:grey\" style=\"color:white; font-weight:bold\">
						Editer
						</button> </TD>";
						echo "<TD><a href=\"del_user.php?login=".$donnees2['User_Login']."\" onclick=\"return confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?')\">
						Supprimer
						</a></TD>";
						echo "</TR>";
					}
					echo "</table>";
					$result2->closeCursor();
					echo "</div>";
					echo "</div>";					
				}
			echo "</div>";	
		}				
		else
		{
			echo "<table border=\"'2\"'><TR>";
			echo "<TH> Nom </TH>";
			echo "<TH> Prénom </TH>";
			echo "<TH> Equipe </TH>";
			echo "<TH> Login </TH>";
			echo "</TR>";
			while ($donnees=$result->fetch())
			{
				echo "<TR>";
				echo "<TD>".$donnees['User_Name']."</TD>";			
				echo "<TD>".$donnees['User_FirstName']."</TD>";			
				echo "<TD>".$donnees['User_EquipeID']."</TD>";			
				echo "<TD>".$donnees['User_Login']."</TD>";
				echo "<TD> <button type=\"button\" onclick=\"self.location.href='edit_user.php?user_login=".$donnees['User_Login']."'\" style=\"background-color:grey\" style=\"color:white; font-weight:bold\">
				Editer
				</button> </TD>";
				echo "<TD><a href=\"del_user.php?login=".$donnees['User_Login']."\" onclick=\"return confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?')\">
				Supprimer
				</a></TD>";
				echo "</TR>";
			}
			echo "</table>";
		}
		$result->closeCursor();
		echo "</br>";
		echo "<h1>Historique sur les utilisateurs</h1>";
		if (isset($_POST['date1']))
		{
			$date1 = $_POST['date1'];
			$date2 = $_POST['date2'];
		}
		else
		{
			$date = date('d-m-Y');
			$date1 = date('d-m-Y', strtotime($date.' - 1 MONTH'));
			$date2 = $date;
		}
	?>
		<form method="POST" action="gestion_user.php">
			<label> Rechercher les historiques utilisateurs entre le </label> 
			<input type="datetime" name="date1" size="30" required="required" value="<?php echo $date1;?>"/>
			<label> et le </label>
			<input type="datetime" name="date2" size="30" required="required" value="<?php echo $date2;?>"/><br/><br/>
			<input type="submit" style="font-size: 20px; border-radius:5px;" value="Rechercher"/>
		</form>
		<br/>
	<?php
		if ($_SESSION['droit'] == 1)
		{
			echo"<div class=\"histo_box\">";
			echo "<div class=\"histo_area\">";
			$result3 = $bdd->query("SELECT histo_Date, histo_User, histype_Name, histo_NameElement FROM Histo INNER JOIN histo_type ON histo_Type = histype_ID WHERE histo_Table = 'user' AND histo_Date BETWEEN '".$date1."' AND '".$date2."'");
			$result3->execute();			
			echo "<table border=\"'2\"'><TR>";
			echo "<TH> Opération </TH>";
			echo "<TH> Utilisateur </TH>";
			echo "<TH> Date </TH>";
			echo "</TR>";
			while ($donnees3 = $result3->fetch())
			{
				echo "<TR>";
				echo "<TD>".$donnees3['histype_Name']." de l'utilisateur ".$donnees3['histo_NameElement']."</TD>";
				echo "<TD>".$donnees3['histo_User']."</TD>";
				echo "<TD>".$donnees3['histo_Date']."</TD>";
				echo "</TR>";
			}
			echo "</table>";
			$result3->closeCursor();
			echo"<div/>";
			echo "<div/>";
		}
		else
		{
			$result3 = $bdd->query("SELECT histo_Date, histo_User, histype_Name, histo_NameElement FROM Histo INNER JOIN histo_type ON histo_Type = histype_ID WHERE histo_Table = 'user' AND histo_Date BETWEEN '".$date1."' AND '".$date2."' AND histo_Team = '".$_SESSION['equipe']."'");
			$result3->execute();	
			echo"<div class=\"histo_box\">";
			echo "<div class=\"histo_area\">";
			echo "<table border=\"'2\"'><TR>";
			echo "<TH> Opération </TH>";
			echo "<TH> Utilisateur </TH>";
			echo "<TH> Date </TH>";
			echo "</TR>";
			while ($donnees3 = $result3->fetch())
			{
				echo "<TR>";
				echo "<TD>".$donnees3['histype_Name']." de l'utilisateur ".$donnees3['histo_NameElement']."</TD>";
				echo "<TD>".$donnees3['histo_User']."</TD>";
				echo "<TD>".$donnees3['histo_Date']."</TD>";
				echo "</TR>";
			}
			echo "</table>";
			$result3->closeCursor();
			echo"<div/>";
			echo "<div/>";
		}
	?>
</body>
</html>
