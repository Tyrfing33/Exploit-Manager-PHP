<?php	
	session_start();	
	if (!isset($_SESSION['login'])) 
	{
		header("Location: connexion.php");
	}
?>
<!-- Page d'édition de tâche-->
<?php	
	include('pattern/connexion_mysql.php');
	include('class/tasks.php');
	#Si la tâche a été modifiée :
	if (isset($_POST['nom']))
	{
		$jour = implode($_POST['jour'], ",");
		$equipe = implode($_POST['equipe'], ",");	
		if ($_POST['ferie'] =='on')
		{
			$_POST['ferie'] = 1;
		}
		else
		{
			$_POST['ferie'] = 0;
		}
		
		if ($_POST['desactivated'] =='on')
		{
			$_POST['desactivated'] = 1;
		}
		else
		{
			$_POST['desactivated'] = 0;
		}
		$task = new Task($_POST['nom'], $_POST['process'], $_POST['fichier'], $_POST['heure'], $jour, $_POST['action'], $_POST['equipe'], $_POST['ferie'], $_POST['desactivated']);
		$task->EditTask($bdd, $_POST['id']);
		$ajouthisto = $bdd->query("INSERT INTO histo (histo_Table, histo_NameElement, histo_Date, histo_User, histo_Team, histo_Type) VALUES ('task','".$_POST['nom']."',NOW(),'".$_SESSION['login']."','".$_SESSION['equipe']."',2)");
		
	}	
	#Si la tâche n'a pas été modifiée, j'affiche ses données.
	if (isset($_POST['id']))
	{
		$result = $bdd->query("SELECT * FROM scheduled_tasks WHERE Task_ID ='".$_POST['id']."'");
	}
	else
	{
		$result = $bdd->query("SELECT * FROM scheduled_tasks WHERE Task_ID ='".$_GET['id_task']."'");
	}	
	$result->execute();	
	$result_team = $bdd->query("SELECT * FROM equipe");
	$result_team->execute();
	while($donnees=$result->fetch())
	{
		$name = $donnees['Task_Name'];
		$action = $donnees['Task_Action'];
		$id = $donnees['Task_ID'];
		$listday = $donnees['Task_Day'];
		$team = $donnees['Task_EquipeID'];
		$file = $donnees['Task_File'];
		$heure = $donnees['Task_Hour'];
		$process = $donnees['Task_Process'];
		$ferie = $donnees['Task_PublicHoliday'];
		$desactivated = $donnees['Desactivated'];
	}	
?>

<!DOCTYPE html>
<head>
	<title> Gestion Exploitation - Edition tâche </title>
</head>


<body>
	<?php
		echo "<TD><button type=\"button\" onclick=\"self.location.href='gestion_tasks.php'\">
		Retour
		</button></TD>";
	?>
	<!-- Formulaire de données de la tâche -->
	<h1>Edition de la tâche <?php echo $name;?> </h1>
	<form method='POST' action='edit_task.php'>
		<label>Nom de la tâche</label><br/>
		<input type="hidden" name="id" value="<?php echo $id;?>"/>
		<input type="text" name="nom" size="30" required="required" value="<?php echo $name;?>"/><br/>
		<label>Action de la tâche</label><br/>
		<?php echo "<input type=\"text\" name=\"action\" size=\"30\" required=\"required\" value=\"".$action."\"/><br/>"?>
		<label> Fichier de procédure (Rentrer le chemin à la main)</label><br/>
		<input type="text" name="process" size="100" value="<?php echo $process;?>"/><br/>
		<label> Fichier à saisir (Rentrer le chemin à la main)<label><br/>
		<input type="text" name="fichier" size="100" value="<?php echo $file;?>"/><br/>
		<label>Equipe assignée</label><br/>
		<?php echo "<input type=\"text\" name=\"equipename\" value=\"".$_SESSION['equipe']."\"disabled/>";?><br/>
		<?php echo "<input type=\"hidden\" name=\"equipe\" value=\"".$_SESSION['equipeID']."\"/>";?>
		<!-- <select name="equipe[]" multiple size="5" required="required" value="<?php echo $team;?>"/><br/>
			 <?php
			// while($donnees_team=$result_team->fetch())
			// {
				// if ($donnees_team['Equipe_ID'] == $team)
				// {
					// echo "<option value=\"".$donnees_team['Equipe_ID']."\" selected=\"selected\">".$donnees_team['Equipe_Name']."</option>";
				// }
				// else
				// {
					// echo "<option value=\"".$donnees_team['Equipe_ID']."\">".$donnees_team['Equipe_Name']."</option>";
				// }
			// }
			
			// ?>
		</select><br/>-->
		<label>Heure de réalisation</label><br/>
		<input type="time" name="heure" required="required" value="<?php echo $heure;?>"/><br/>
		<label>Jour de réalisation</label><br/>
		<select name="jour[]" multiple size="5" required="required"/><br/>
			<?php
				if (preg_match("#Lundi#", $listday))
				{
					echo "<option value=\"Lundi\" selected=\"selected\">Lundi</option>";
				}
				else
				{
					echo "<option value=\"Lundi\">Lundi</option>";
				}
				if (preg_match("#Mardi#", $listday))
				{
					echo "<option value=\"Mardi\" selected=\"selected\">Mardi</option>";
				}
				else
				{
					echo "<option value=\"Mardi\">Mardi</option>";
				}
				if (preg_match("#Mercredi#", $listday))
				{
					echo "<option value=\"Mercredi\" selected=\"selected\">Mercredi</option>";
				}
				else
				{
					echo "<option value=\"Mercredi\">Mercredi</option>";
				}
				if (preg_match("#Jeudi#", $listday))
				{
					echo "<option value=\"Jeudi\" selected=\"selected\">Jeudi</option>";
				}
				else
				{
					echo "<option value=\"Jeudi\">Jeudi</option>";
				}
				if (preg_match("#Vendredi#", $listday))
				{
					echo "<option value=\"Vendredi\" selected=\"selected\">Vendredi</option>";
				}
				else
				{
					echo "<option value=\"Vendredi\">Vendredi</option>";
				}
				if (preg_match("#Samedi#", $listday))
				{
					echo "<option value=\"Samedi\" selected=\"selected\">Samedi</option>";
				}
				else
				{
					echo "<option value=\"Samedi\">Samedi</option>";
				}
				if (preg_match("#Dimanche#", $listday))
				{
					echo "<option value=\"Dimanche\" selected=\"selected\">Dimanche</option>";
				}
				else
				{
					echo "<option value=\"Dimanche\">Dimanche</option>";
				}
				?>
		</select><br/>
		<label>Lancer les jours fériés ?</label><br/>
		<input type="checkbox" name="ferie" <?php if ($ferie == 1) { echo "value=\"on\"";}?>></input></br>
		<label>Tâche désactivée</label><br/>
		<input type="checkbox" name="desactivated" <?php if ($desactivated == 1) { echo "value=\"on\"";}?>></input></br>
		<input type="submit" value="Editer"></input>
	</form>	
</body>
</html>