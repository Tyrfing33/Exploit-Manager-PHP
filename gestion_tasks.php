<?php	
	session_start();	
	if (!isset($_SESSION['login'])) 
	{
		header("Location: connexion.php");
	}
?>

<?php
	include('pattern/connexion_mysql.php');
	session_start();
	$result = $bdd->query("SELECT * FROM scheduled_tasks WHERE Task_EquipeID =".$_SESSION['equipeID']."");
	$result->execute();	
	$result2 = $bdd->query("SELECT * FROM scheduled_tasks");
	$result2->execute();
?>
<!DOCTYPE html>
<head>
<title> Gestion Exploitation - Gestion des utilisateurs </title>
</head>
<body>
	<input type="button" value="Retour" onClick="document.location.href='backoffice.php'"/>
	<h1>Gestion des tâches programmées</h1>
	<?php
		echo "<input type=\"button\" value=\"Ajouter tâche\" onClick=\"document.location.href='add_task.php'\" style=\"'background-color:grey\"' style=\"'color:white; font-weight:bold\"'/>";
		echo "<table border=\"'2\"'><TR>";
		echo "<TH> Nom </TH>";
		echo "<TH> Heure </TH>";
		echo "<TH> Jour </TH>";
		echo "<TH> Action </TH>";
		echo "<TH> Equipe </TH>";
		echo "<TH> Jour férié </TH>";
		echo "</TR>";
		if ($_SESSION['droit']==1)
		{
		
			while ($donnees2=$result2->fetch())
			{
				echo "<TR>";
				echo "<TD>".$donnees2['Task_Name']."</TD>";			
				echo "<TD>".$donnees2['Task_Hour']."</TD>";			
				echo "<TD>".$donnees2['Task_Day']."</TD>";			
				echo "<TD>".$donnees2['Task_Action']."</TD>";
				echo "<TD>".$donnees2['Task_EquipeID']."</TD>";
				echo "<TD>".$donnees2['Task_PublicHoliday']."</TD>";
				echo "<TD><button type=\"button\" onclick=\"self.location.href='edit_task.php?id_task=".$donnees2['Task_ID']."'\" style=\"background-color:grey\" style=\"color:white; font-weight:bold\">
				Editer
				</button></TD>";
				echo "<TD><a href=\"del_task.php?id_task=".$donnees2['Task_ID']."\" onclick=\"return confirm('Êtes-vous sûr de vouloir supprimer cette tâche ?')\">
				Supprimer
				</a></TD>";
				echo "</TR>";			
			}
			echo "</table>";				
		}
		else
		{
			while ($donnees=$result->fetch())
			{
				echo "<TR>";
				echo "<TD>".$donnees['Task_Name']."</TD>";			
				echo "<TD>".$donnees['Task_Hour']."</TD>";			
				echo "<TD>".$donnees['Task_Day']."</TD>";			
				echo "<TD>".$donnees['Task_Action']."</TD>";
				echo "<TD>".$donnees['Task_EquipeID']."</TD>";
				echo "<TD>".$donnees['Task_PublicHoliday']."</TD>";
				echo "<TD><button type=\"button\" onclick=\"self.location.href='edit_task.php?id_task=".$donnees['Task_ID']."'\" style=\"background-color:grey\" style=\"color:white; font-weight:bold\">
				Editer
				</button></TD>";
				echo "<TD><a href=\"del_task.php?id_task=".$donnees['Task_ID']."\" onclick=\"return confirm('Êtes-vous sûr de vouloir supprimer cette tâche ?')\">
				Supprimer
				</a></TD>";
				echo "</TR>";			
			}
			echo "</table>";			
		}
		$result->closeCursor();	
		$result2->closeCursor();
		$result3 = $bdd->query("SELECT histo_Date, histo_User, histype_Name, histo_NameElement FROM histo INNER JOIN histo_type ON histo_Type = histype_ID WHERE histo_Table = 'task'");
		$result3->execute();
		echo "<h1>historique sur les tâches planifiées</h1>";
		echo "<table border=\"'2\"'><TR>";
		echo "<TH> Opération </TH>";
		echo "<TH> Utilisateur </TH>";
		echo "<TH> Date </TH>";
		echo "</TR>";
		while ($donnees3 = $result3->fetch())
		{
			echo "<TR>";
			echo "<TD>".$donnees3['histype_Name']." de la tâche ".$donnees3['histo_NameElement']."</TD>";
			echo "<TD>".$donnees3['histo_User']."</TD>";
			echo "<TD>".$donnees3['histo_Date']."</TD>";
			echo "</TR>";
		}
		echo "</table>";
		$result3->closeCursor();
	?>
</body>
</html>
