<?php	
	session_start();	
	if (!isset($_SESSION['login'])) 
	{
		header("Location: connexion.php");
	}
	$idonglet=1;
?>

<?php
	include('pattern/connexion_mysql.php');
	session_start();
	$result = $bdd->query("SELECT * FROM scheduled_tasks INNER JOIN equipe ON Task_EquipeID = Equipe_ID WHERE Task_EquipeID =".$_SESSION['equipeID']." ORDER BY Task_Hour");
	$result->execute();	
	$result2 = $bdd->query("SELECT * FROM scheduled_tasks ORDER BY Task_Hour");
	$result2->execute();
	$onglet = $bdd->query("SELECT * FROM equipe");
	$onglet->execute();
?>
<script type="text/javascript">
function date_heure(id)
{
        date = new Date;
        annee = date.getFullYear();
        moi = date.getMonth();
        mois = new Array('Janvier', 'F&eacute;vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao&ucirc;t', 'Septembre', 'Octobre', 'Novembre', 'D&eacute;cembre');
        j = date.getDate();
        jour = date.getDay();
        jours = new Array('Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi');
        h = date.getHours();
        if(h<10)
        {
                h = "0"+h;
        }
        m = date.getMinutes();
        if(m<10)
        {
                m = "0"+m;
        }
        s = date.getSeconds();
        if(s<10)
        {
                s = "0"+s;
        }
        resultat = ''+jours[jour]+' '+j+' '+mois[moi]+' '+annee+'';
        document.getElementById(id).innerHTML = resultat;
        setTimeout('date_heure("'+id+'");','1000');
        return true;
}
</script>

<!DOCTYPE html>
<head>
<title> Gestion Exploitation - Gestion des utilisateurs </title>
</head>
<link rel="stylesheet" type="text/css" href="css/menu_task.css"/>
<body>
	<header id="header">		
		<div id="th_logo"> <img style="size:50px;" class="logo" src="css/logo.png" alt=""/></div>
		<div id="th_session">
			<div class="dropdownname">
				 <button class="boutonmenuprincipal1"><?php echo "<p>".$_SESSION["nom"]." ".$_SESSION["prenom"]."<p/>";?></button>
				 <div class="dropdown-child1">
					 <a href="connexion.php?logout=1">Se déconnecter</a>					 
				 </div>
			 </div>	
			<div class="dropdownsettings">
				<button class="boutonmenuprincipal2"><img style="height:47px;" class="parameter_icon" src="css/iconpoint.png"/></button>
				<div class="dropdown-child2">
					 <a href="work.php">Accueil</a>	
					 <a href="gestion_user.php">Gérer utilisateurs</a>
					 <a href="gestion_tasks.php">Gérer tâches</a>
				</div>
			</div>		
					 		
		</div>		
		<div id="date_heure">
			<script type="text/javascript">window.onload = date_heure('date_heure');</script>	
		</div>
	</header>			
	<h1>Gestion des tâches programmées</h1>
	<?php
		
		if ($_SESSION['droit'] == 1)
		{
			echo "<input type=\"button\" value=\"Ajouter tâche\" onClick=\"document.location.href='add_task.php'\" style=\"width:100px; font-size:15px;\"/></br>";
			echo"<div id=\"tabs\" class=\"tabbed_box\">";			
			echo "<div class=\"tabbed_area\">";			
			echo "<ul class=\"tabs\">";
				$numero = 1;
				while ($onglets=$onglet->fetch())
				{					
					echo "<li> <a href=\"gestion_tasks.php?idonglet=".$onglets['Equipe_ID']."\" id=\"tab_".$numero."\"class=\"\">".$onglets['Equipe_Name']."</a></li>";
					$numero = $numero + 1;						
				}
			echo "</ul></br>";				
			if (isset($_GET['idonglet']))
			{
				$idonglet = $_GET['idonglet'];
				echo "<input type=\"button\" value=\"Ajouter tâche\" onClick=\"document.location.href='add_task.php'\" style=\"margin-right:69%; width:160px; font-size:20px; color:black; font-weight:bold\"/></br>";
				echo "<div id=\"content\" class=\"content\">";
				echo "<table border=\"'2\"'><TR>";
				echo "<TH> Nom </TH>";
				echo "<TH> Heure </TH>";
				echo "<TH> Jour </TH>";
				echo "<TH> Action </TH>";
				echo "<TH> Equipe </TH>";				
				echo "<TH> Tâche activée </TH>";
				echo "</TR>";
				$result2 = $bdd->query("SELECT * FROM scheduled_tasks INNER JOIN equipe ON Task_EquipeID = Equipe_ID WHERE Task_EquipeID=".$idonglet." ORDER BY Task_Hour");
				$result2->execute();
				while ($donnees2=$result2->fetch())
				{
					echo "<TR>";
					echo "<TD>".$donnees2['Task_Name']."</TD>";			
					echo "<TD>".$donnees2['Task_Hour']."</TD>";			
					echo "<TD>".$donnees2['Task_Day']."</TD>";			
					echo "<TD>".$donnees2['Task_Action']."</TD>";
					echo "<TD>".$donnees2['Equipe_Name']."</TD>";										
					if ($donnees2['Desactivated'] == 1)
					{
						$desactivated = "non";
					}
					else
					{
						$desactivated = "oui";
					}
					echo "<TD>".$desactivated."</TD>";
					echo "<TD><button type=\"button\" onclick=\"self.location.href='edit_task.php?id_task=".$donnees2['Task_ID']."'\" style=\"color:black; font-weight:bold\">
					Editer
					</button></TD>";
					echo "<TD><button type=\"button\" <a href=\"del_task.php?id_task=".$donnees2['Task_ID']."\" onclick=\"return confirm('Êtes-vous sûr de vouloir supprimer cette tâche ?')\">
					Supprimer
					</a></TD>";
					echo "</TR>";			
				}
				echo "</table>";				
			}
			else
			{
				echo "<input type=\"button\" value=\"Ajouter tâche\" onClick=\"document.location.href='add_task.php'\" style=\"margin-right:70%; font-size:25px; color:black; font-weight:bold\"/></br>";
				echo "<div id=\"content\" class=\"content\">";
				echo "<table border=\"'2\"'><TR>";
				echo "<TH> Nom </TH>";
				echo "<TH> Heure </TH>";
				echo "<TH> Jour </TH>";
				echo "<TH> Action </TH>";
				echo "<TH> Equipe </TH>";				
				echo "<TH> Tâche activée </TH>";
				echo "</TR>";
				$result2 = $bdd->query("SELECT * FROM scheduled_tasks INNER JOIN equipe ON Task_EquipeID = Equipe_ID WHERE Task_EquipeID=".$idonglet." ORDER BY Task_Hour");
				$result2->execute();
				while ($donnees2=$result2->fetch())
				{
					echo "<TR>";
					echo "<TD>".$donnees2['Task_Name']."</TD>";			
					echo "<TD>".$donnees2['Task_Hour']."</TD>";			
					echo "<TD>".$donnees2['Task_Day']."</TD>";			
					echo "<TD>".$donnees2['Task_Action']."</TD>";
					echo "<TD>".$donnees2['Equipe_Name']."</TD>";										
					if ($donnees2['Desactivated'] == 1)
					{
						$desactivated = "non";
					}
					else
					{
						$desactivated = "oui";
					}
					echo "<TD>".$desactivated."</TD>";
					echo "<TD><button type=\"button\" onclick=\"self.location.href='edit_task.php?id_task=".$donnees2['Task_ID']."'\" style=\"color:black; font-weight:bold\">
					Editer
					</button></TD>";
					echo "<TD><button type=\"button\" <a href=\"del_task.php?id_task=".$donnees2['Task_ID']."\" onclick=\"return confirm('Êtes-vous sûr de vouloir supprimer cette tâche ?')\">
					Supprimer
					</a></TD>";
					echo "</TR>";			
				}
				echo "</table>";
			}
		}
		else
		{
			echo "<input type=\"button\" value=\"Ajouter tâche\" onClick=\"document.location.href='add_task.php'\" style=\"margin-right:45%;\"/></br>";
			echo "<table border=\"'2\"'><TR>";
			echo "<TH> Nom </TH>";
			echo "<TH> Heure </TH>";
			echo "<TH> Jour </TH>";
			echo "<TH> Action </TH>";
			echo "<TH> Equipe </TH>";			
			echo "<TH> Tâche activée </TH>";
			echo "</TR>";
			while ($donnees=$result->fetch())
			{
				echo "<TR>";
				echo "<TD>".$donnees['Task_Name']."</TD>";			
				echo "<TD>".$donnees['Task_Hour']."</TD>";			
				echo "<TD>".$donnees['Task_Day']."</TD>";			
				echo "<TD>".$donnees['Task_Action']."</TD>";
				echo "<TD>".$donnees['Equipe_Name']."</TD>";								
				if ($donnees['Desactivated'] == 1)
					{
						$desactivated = "non";
					}
					else
					{
						$desactivated = "oui";
					}
					echo "<TD>".$desactivated."</TD>";
				echo "<TD><button type=\"button\" onclick=\"self.location.href='edit_task.php?id_task=".$donnees['Task_ID']."'\" style=\"color:black; font-weight:bold\">
				Editer
				</button></TD>";
				echo "<TD><button type=\"button\" style=\"color:red; font-weight:bold\" <a href=\"del_task.php?id_task=".$donnees['Task_ID']."\" onclick=\"return confirm('Êtes-vous sûr de vouloir supprimer cette tâche ?')\">
				Supprimer
				</a></TD>";
				echo "</TR>";			
			}
			echo "</table>";			
		}
		$result->closeCursor();	
		$result2->closeCursor();
		echo "<h1>Historique sur les tâches planifiées</h1>";
		if (isset($_POST['date1']))
		{
			$date1 = $_POST['date1'];
			$date2 = $_POST['date2'];
		}
		else
		{
			$date = date('Y-m-d');
			$date1 = date('Y-m-d', strtotime($date.' - 1 MONTH'));
			$date2 = $date;
		}
	?>
		<form method="POST" action="gestion_tasks.php">
			<label> Rechercher les historiques des tâches planifiées entre le </label> 
			<input type="date" name="date1" size="30" required="required" value="<?php echo $date1;?>"/>
			<label> et le </label>
			<input type="date" name="date2" size="30" required="required" value="<?php echo $date2;?>"/><br/><br/>
			<input type="submit" style="font-size: 20px; border-radius:5px;" value="Rechercher"/>
		</form>
	<?php
		if ($_SESSION['droit'] == 1)
		{
			$result3 = $bdd->query("SELECT histo_Date, histo_User, histo_Team, histype_Name, histo_NameElement FROM histo INNER JOIN histo_type ON histo_Type = histype_ID WHERE histo_Table = 'task' AND histo_Date BETWEEN '".$_POST['date1']."' AND '".$_POST['date2']."'");
			$result3->execute();			
			echo "<table border=\"'2\"'><TR>";
			echo "<TH> Opération </TH>";
			echo "<TH> Utilisateur </TH>";
			echo "<TH> Equipe </TH>";
			echo "<TH> Date </TH>";
			echo "</TR>";
			while ($donnees3 = $result3->fetch())
			{
				echo "<TR>";
				echo "<TD>".$donnees3['histype_Name']." de la tâche ".$donnees3['histo_NameElement']."</TD>";
				echo "<TD>".$donnees3['histo_User']."</TD>";
				echo "<TD>".$donnees3['histo_Team']."</TD>";
				echo "<TD>".$donnees3['histo_Date']."</TD>";
				echo "</TR>";
			}
			echo "</table>";
			$result3->closeCursor();
		}
		else
		{
			$result3 = $bdd->query("SELECT histo_Date, histo_User, histo_Team, histype_Name, histo_NameElement FROM histo INNER JOIN histo_type ON histo_Type = histype_ID WHERE histo_Table = 'task' AND histo_Date BETWEEN '".$_POST['date1']."' AND '".$_POST['date2']."' AND histo_Team = '".$_SESSION['equipe']."'");
			$result3->execute();			
			echo "<table border=\"'2\"'><TR>";
			echo "<TH> Opération </TH>";
			echo "<TH> Utilisateur </TH>";
			echo "<TH> Equipe </TH>";
			echo "<TH> Date </TH>";
			echo "</TR>";
			while ($donnees3 = $result3->fetch())
			{
				echo "<TR>";
				echo "<TD>".$donnees3['histype_Name']." de la tâche ".$donnees3['histo_NameElement']."</TD>";
				echo "<TD>".$donnees3['histo_User']."</TD>";
				echo "<TD>".$donnees3['histo_Team']."</TD>";
				echo "<TD>".$donnees3['histo_Date']."</TD>";
				echo "</TR>";
			}
			echo "</table>";
			$result3->closeCursor();
		}
	?>
</body>
</html>
