<!-- Partie PHP, POST Formulaire de connexion -->

<?php

#On inclus le fichier CSS
include('css/menu_auth.css');

#On inclus le pattern de connexion à mysql
session_start();
include('pattern/connexion_mysql.php');

#On crée la classe Authentification qui nous servira à récupérer les informations de connexion de l'utilisateur dans la base de données	
class Authentification
	{
		private $login;
		private $nom;
		private $prenom;
		private $team;
		private $teamID;
		
		#Constructeur par défaut de la classe Authentification.
		public function Authentification($login_auth, $bdd)
		{
			$reponse = $bdd->query("SELECT User_Login, User_FirstName, User_Name, User_EquipeID, Equipe_Name, Equipe_ID FROM user INNER JOIN equipe ON equipe.Equipe_ID = user.User_EquipeID WHERE User_Login = '".$login_auth."'");
			$reponse->execute();
			while ($donnees = $reponse->fetch())
			{
				$this->login = $donnees["User_Login"];
				$this->nom = $donnees["User_Name"];
				$this->prenom = $donnees["User_FirstName"];
				$this->team = $donnees["Equipe_Name"];
				$this->teamID = $donnees["Equipe_ID"];
			}			
			$reponse->closeCursor();			
		}
		public function __destruct()
		{			
		}
		
		public function getTeamID()
		{
			return $this->teamID;
		}
		
		public function getNom()
		{
			return $this->nom;
		}

		public function getPrenom()
		{
			return $this->prenom;
		}

		public function getTeam()
		{
			return $this->team;
		}	
		
		public function getLogin()
		{
			return $this->login;
		}		
	}

#On test si la variable $_POST['logout'] existe, si oui cela veut dire que l'utilisateur s'est déconnecté et qu'il faut détruire la session
if (isset($_POST['logout']))
{
	session_destroy();		
}	

#On initialise la variable $error pour la gestion d'erreur sur le formulaire	
$error=0;

#On test si la variable $_POST['login'] existe, si oui cela veut dire que l'utilisateur a cliqué sur le bouton Connexion
if (isset($_POST["login"]))
{
	$ds = ldap_connect("192.168.0.180");  // On initialise la connexion au domaine (doit être un serveur LDAP valide !)
	if (@ldap_bind($ds, $_POST["login"]."@CISVALLEY", $_POST["mdp"])) //On teste si la connexion LDAP est OK avec le login utilisateur et le mot de passe tapé.
	{
		#Si connexion LDAP OK, on initialise un objet Authentification
		$auth = new Authentification($_POST["login"], $bdd); 
		#On initialise la session pour lui appliquer plusieurs informations utilisateur
		session_start();
		$_SESSION['login'] = $auth->getLogin();
		$_SESSION['nom'] = $auth->getNom();
		$_SESSION['prenom'] = $auth->getPrenom();
		$_SESSION['equipe'] = $auth->getTeam();
		$_SESSION['equipeID'] = $auth->getTeamID();
		#On teste l'attribut teamleader ou non de l'utilisateur
		$user_teamlead = $bdd->query("SELECT Equipe_TeamLeader FROM equipe WHERE Equipe_TeamLeader = '".$_SESSION['login']."'");
		$user_teamlead->execute();
		$result = $user_teamlead->fetch();
		if (isset($result["Equipe_TeamLeader"]))
		{
			$_SESSION['teamleader'] = true;
		}
		else
		{
			$_SESSION['teamleader'] = false;
		}
		#Une fois l'objet session complètement renseigné, on détruit l'objet Authentification
		$auth->__destruct();
		#Puis on redirige vers la page de travail
		header('Location:work.php');		
	}	
	else //Si la connexion ne passe pas, on passe la variable $error à 1
	{
		$error=1;
	}	
}
?>
<!-- Fin partie PHP -->

<!-- Début structure HTML-->
<!DOCTYPE html>
<head>
<title> Gestion Exploitation - Connexion </title>
</head>
<body>
	<h1>Connexion</h1>
	<?php
		#Si la variable $error décrite plus haut est à 1, alors on affiche le message d'erreur
		if ($error == 1)
		{
			echo  '<label style="color:red"> Login ou mot de passe incorrect</label><br/><br/>';
		}
	?>
	<!-- Formulaire de connexion -->
	<form method="post" action="connexion.php">
	<label>Login AD</label><br/>
    <input type="text" name="login" size="30" required="required"/><br/>
	<label>MDP</label><br/>
    <input type="password" name="mdp" size="30" required="required"/><br/>
	<input type="submit" value="Connexion"></input>
	</form>
</body>
</html>

<!-- Fin structure HTML -->
