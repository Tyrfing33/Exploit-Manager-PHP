<?php	
	session_start();	
	if (!isset($_SESSION['login']) or $_SESSION['droit']==3) 
	{
		header("Location: connexion.php");
	}
?>
<!-- Page d'édition utilisateur -->
<?php	
	include('class/user.php');
	include('pattern/connexion_mysql.php');
	#Si l'utilisateur a été modifié :
	if (isset($_POST['login']))
	{
		#Je crée un objet User et j'utilise la méthode EditUser, puis je détruis l'objet et je redirige vers la gestion des utilisateurs
		$edit_user = new User($_POST['login'], $_POST['prenom'], strtoupper($_POST['nom']), $_POST['equipe'], $_POST['droit']);
		$edit_user->EditUser($bdd, $_POST['user_id']);
		$ajouthisto = $bdd->query("INSERT INTO histo (histo_Table, histo_NameElement, histo_Date, histo_User, histo_Team, histo_Type) VALUES ('user','".$_POST['login']."',NOW(),'".$_SESSION['login']."','".$_SESSION['equipe']."',2)");
		$edit_user->__destruct();
		header('Location: gestion_user.php');
	}
	#Si l'utilisateur n'a pas été modifié, j'affiche ses données.
	else
	{
		$result = $bdd->query("SELECT User_ID,User_Login, User_Name, User_FirstName, User_EquipeID, User_Rights, Nom AS Droit, Equipe_Name FROM user INNER JOIN equipe ON Equipe_ID = User_EquipeID INNER JOIN droit ON droit.ID = User_Rights WHERE User_Login ='".$_GET['user_login']."'");
		$result->execute();	
		while($donnees=$result->fetch())
		{
			$id = $donnees['User_ID'];
			$login = $donnees['User_Login'];
			$nom = $donnees['User_Name'];
			$prenom = $donnees['User_FirstName'];
			$team = $donnees['User_EquipeID'];
			$teamname= $donnees['Equipe_Name'];
			$droit = $donnees['User_Rights'];
			$nomdroit = $donnees['Droit'];
		}	
		$request2 = $bdd->query("SELECT * FROM equipe");
		$request2->execute();
		$request3 = $bdd->query("SELECT * FROM droit");
		$request3->execute();
	}	
?>

<!DOCTYPE html>
<head>
	<title> Gestion Exploitation - Edition utilisateur </title>
</head>


<body>
	<?php
		echo "<TD><button type=\"button\" onclick=\"self.location.href='gestion_user.php'\">
		Retour
		</button></TD>";
	?>
	<!-- Formulaire de données de l'utilisateur -->
	<h1>Edition de l'utilisateur <?php echo $login;?> </h1>
	<?php
		if ($_SESSION['droit']==1)
		{
			echo "<form method='POST' action='edit_user.php'>
			<label>Prénom</label><br/>
			<input type=\"hidden\" name=\"user_id\" value=\"".$id."\"/>
			<input type=\"text\" name=\"prenom\" size=\"30\" required=\"required\" value=\"".$prenom."\"/><br/>
			<label>Nom</label><br/>
			<input type=\"text\" name=\"nom\" size=\"30\" required=\"required\" style=\"text-transform:uppercase;\" value=\"".$nom."\"/><br/>
			<label>Login AD</label><br/>
			<input type=\"text\" name=\"login\" size=\"30\" required=\"required\" value=\"".$login."\"/><br/>
			<label>Equipe</label><br/>
			<select name=\"equipe\" size=\"5\" required=\"required\"/><br/>";
			while ($donnees2=$request2->fetch())
			{
				if ($team==$donnees2['Equipe_ID'])
				{
					echo "<option value=\"".$donnees2['Equipe_ID']."\" selected=\"selected\">".$donnees2['Equipe_Name']."</option>";
				}
				else
				{
					echo "<option value=\"".$donnees2['Equipe_ID']."\">".$donnees2['Equipe_Name']."</option>";
				}					
			}
			$request2->closeCursor();
			echo "</select><br/>";
			
			echo "<label>Profil</label><br/>
			<select name=\"droit\" size=\"3\" required=\"required\"/><br/>";
			while ($donnees3=$request3->fetch())
			{
				if ($droit==$donnees3['ID'])
				{
					echo "<option value=\"".$donnees3['ID']."\" selected=\"selected\">".$donnees3['Nom']."</option>";
				}
				else
				{						
					echo "<option value=\"".$donnees3['ID']."\">".$donnees3['Nom']."</option>";
				}
			}
			$request3->closeCursor();
			echo "</select><br/>";

			echo "<input type=\"submit\" value=\"Editer\"></input>	
		</form>";
	
		}
		else
		{
			echo "<form method=\"POST\" action=\"edit_user.php\">		
				<label>Prénom</label><br/>
				<input type=\"hidden\" name=\"user_id\" value=\"".$id."\"/>
				<input type=\"text\" name=\"prenom\" size=\"30\" required=\"required\" value=\"".$prenom."\"/><br/>
				<label>Nom</label><br/>
				<input type=\"text\" name=\"nom\" size=\"30\" required=\"required\" style=\"text-transform:uppercase;\" value=\"". $nom."\"/><br/>
				<label>Login AD</label><br/>
				<input type=\"text\" name=\"login\" size=\"30\" required=\"required\" value=\"".$login."\"/><br/>
				<label>Equipe</label><br/>
				<input type=\"text\" name=\"equipename\" value=\"".$teamname."\"disabled/><br/>
				<input type=\"hidden\" name=\"equipe\" value=\"".$team."\"/>
				<label>Profil</label>
				<input type=\"text\" name=\"droitname\" value=\"".$nomdroit."\"disabled/><br/>
				<input type=\"hidden\" name=\"droit\" value=\"".$droit."\"/>
				<input type=\"submit\" value=\"Editer\"></input>
			</form>";			
		}
	?>
</body>
</html>
