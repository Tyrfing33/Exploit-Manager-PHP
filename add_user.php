<?php	
	session_start();	
	if (!isset($_SESSION['login']) or $_SESSION['droit']==3) 
	{
		header("Location: connexion.php");
	}
?>
<?php
$error=0;
include('pattern/connexion_mysql.php');
include('class/user.php');
if (isset($_POST['login']))
{
	$new_user = new User($_POST['login'], $_POST['prenom'], strtoupper($_POST['nom']), $_POST['equipe'], $_POST['droit']);
	if($new_user->VerifyUser($bdd) == true)
	{
		$error = 1;
		echo "ERREUR";
	}
	else
	{
		$new_user->AddUser($bdd);
		$request=$bdd->query("SELECT User_Login FROM user WHERE User_Login ='".$_POST['login']."'");
		$request->execute();
		$donnees = $request->fetch();
		$request->closeCursor();
		$datetime=date('d-m-Y H:i:s');
		$ajouthisto = $bdd->query("INSERT INTO histo (histo_Table, histo_NameElement, histo_Date, histo_User, histo_Type) VALUES ('user','".$donnees['User_Login']."',NOW(),'".$_SESSION['login']."',1)");		
		header('Location:gestion_user.php');
	}
	$new_user->__destruct();
}
?>

<!DOCTYPE html>
<head>
<title> Gestion Exploitation - Ajout d'utilisateur </title>
</head>
<body>
	<?php
		echo "<TD><button type=\"button\" onclick=\"self.location.href='gestion_user.php'\">
		Retour
		</button></TD>";
		if($_SESSION['droit'] == 1)
		{
			$request=$bdd->query('SELECT * FROM equipe');
			$request->execute();
			$request2=$bdd->query('SELECT * FROM droit');
			$request2->execute();
			echo "<form method='POST' action='add_user.php'>
				<label>Prénom</label><br/>
				<input type=\"text\" name=\"prenom\" size=\"30\" required=\"required\"/><br/>
				<label>Nom</label><br/>
				<input type=\"text\" name=\"nom\" size=\"30\" required=\"required\" style=\"text-transform:uppercase;\"/><br/>
				<label>Login AD</label><br/>
				<input type=\"text\" name=\"login\" size=\"30\" required=\"required\"/><br/>
				<label>Equipe</label><br/>
				<select name=\"equipe\" size=\"5\" required=\"required\"/><br/>";
				while ($donnees=$request->fetch())
				{
					echo "<option value=\"".$donnees['Equipe_ID']."\">".$donnees['Equipe_Name']."</option>";
				}
				$request->closeCursor();
				echo "</select><br/>";
				
				echo "<label>Profil</label><br/>
				<select name=\"droit\" size=\"3\" required=\"required\"/><br/>";
				while ($donnees2=$request2->fetch())
				{
					echo "<option value=\"".$donnees2['ID']."\">".$donnees2['Nom']."</option>";
				}
				$request2->closeCursor();
				echo "</select><br/><br/>";

				echo "<input type=\"submit\" value=\"Ajouter\"></input>	
			</form>";
		}	
		else
		{
			echo "<form method='POST' action='add_user.php'>
				<label>Prénom</label><br/>
				<input type=\"text\" name=\"prenom\" size=\"30\" required=\"required\"/><br/>
				<label>Nom</label><br/>
				<input type=\"text\" name=\"nom\" size=\"30\" required=\"required\" style=\"text-transform:uppercase;\"/><br/>
				<label>Login AD</label><br/>
				<input type=\"text\" name=\"login\" size=\"30\" required=\"required\"/><br/>
				<input type=\"hidden\" name=\"equipe\" value=\"".$_SESSION['equipeID']."\"/>
				<input type=\"submit\" value=\"Ajouter\"></input>	
			</form>";
		}
	?>
</body>
</html>
