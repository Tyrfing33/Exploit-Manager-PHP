<?php	
	session_start();	
	if (!isset($_SESSION['login'])) 
	{
		header("Location: connexion.php");
	}
?>

<!-- Page de détail d'une tâche -->
<?php
session_start();
include('pattern/connexion_mysql.php');
include('class/tasks.php');

$result = $bdd->prepare("SELECT * FROM work INNER JOIN scheduled_tasks ON Task_ID = Work_TaskID INNER JOIN equipe ON Task_EquipeID = Equipe_ID WHERE Work_ID =".$_GET['id_task']);
$result->execute();

if (isset($_POST['date_done']))
{
	$finish = $bdd->prepare("UPDATE work SET Work_HourDone = ?, Work_Realised = 1, Work_Commentary = ?, Work_OK = ?, Work_DayRealised = ?, Work_UserName = ? WHERE Work_ID =".$_GET['id_task']);
	$finish->execute(array($_POST['hour_done'], $_POST['comment'], $_POST['task_okko'], $_POST['date_done'], $_SESSION['login']));
	header('Location:work.php');
}

?>

<!DOCTYPE html>
<head>
<title> Gestion Exploitation - Finalisation de la tâche </title>
</head>
<link rel="stylesheet" type="text/css" href="css/menu_finishtask.css"/>
<body>
	<div id="div_finish">
		<?php
			$time = date("H:i");
			$date = date("Y-m-d");
			echo "<button type=\"button\" onclick=\"self.location.href='work.php'\" style=\"font-size: 20px; border-radius:5px;\"onclick>
			Retour
			</button><br/>";
			$donnees=$result->fetch();
			echo "<p><b>Nom de la tâche</b></p>";
			echo "<p>".$donnees['Task_Name']."</p>";
			echo "<p><b>Equipe assignée</b></p>";
			echo "<p>".$donnees['Equipe_Name']."<p/>";
			echo "<p><b>Heure de début</b></p>";
			echo "<p>".$donnees['Task_Hour']."</p>";
			echo "<p><b>Date de début</b></p>";
			echo "<p>".$donnees['Work_DayToRealise']."</p>";
			echo "<div id=\"finish_task\">";
			echo "<form method=\"POST\" action=\"finish_task.php?id_task=".$_GET['id_task']."\">";
			echo "<p><b>Heure de fin</b></p>";
			echo "<input class=\"champ\" type=\"time\" name=\"hour_done\" value=\"".$time."\" required=\"required\"/><br/>";		
			echo "<input type=\"HIDDEN\" name=\"date_done\" value=\"".$date."\"/>";
			echo "<p><b>Tâche OK/KO ?</b></p>";
			echo "<select class=\"champ\" name=\"task_okko\"/><br/>";
				echo "<option value=\"1\">OK</option>";
				echo "<option value=\"'0\"'>KO</option>";
			echo "</select>";
			echo "<p><b>Commentaire</b></p>";
			echo "<textarea class=\"text\" name=\"comment\"></textarea><br/><br/>";
			echo "<input type=\"submit\" style=\"font-size: 16px; border-radius:5px;\" value=\"Finaliser la tâche\"/>";
			echo "</div>";
			$result->closeCursor();		
		?>
	</div>
</body>
</html>